---
title: "Blood plasma profiling using proximity extension assay in patients with acute myeloid leukemia"
subtitle: "Machine learning analyses"
author: "Emil Johansson, María Bueno Álvez, Sören Lehmann, Tobias Sjöblom, Ulf Gyllensten, Fredrik Pontén, Göran Bergström, Adil Mardinouglu, Wen Zhong, Mathias Uhlén & Fredrik Edfors"
date: last-modified
date-format: "dddd [the] Do [of] MMMM YYYY"
format:
  html:
    theme: lumen
    title-block-banner: true
    smooth-scroll: true
    toc: true
    toc-depth: 4
    toc-location: right
    number-sections: true
    number-depth: 4
    code-fold: true
    code-tools: true
    code-copy: true
    code-overflow: wrap
    df-print: kable
    standalone: true
    fig-align: left
    figure:
      caption: "Figure {number}: {label}"
editor_options: 
  chunk_output_type: inline
execute:
  echo: true
  message: false
  warning: false
params: 
  disease: "Abdominal aortic aneruysm"
editor: 
  markdown: 
    wrap: 72
---

Start of document.

# Background

## Introduction

Welcome to the quarto report presenting the code used to generate the content to the article: "Blood proteome profiling using proximity extension assay in patients with acute myeloid leukemia" by Emil Johansson, María Bueno Álvez, Sören Lehmann, Tobias Sjöblom, Ulf Gyllensten, Fredrik Pontén, Göran Bergström, Adil Mardinouglu, Wen Zhong, Mathias Uhlén & Fredrik Edfors..

## The study

The results from the study are published in **insert journal**: Johansson, E, et al. Blood proteome profiling using proximity extension assay in patients with acute myeloid leukemia. Insert journal here\* (2024). **insert DOI here**

## Access the data/scripts

The results generated by this study can be accessed through the Human Protein Atlas (HPA) (<https://www.proteinatlas.org/>). More specifically, the data is presented in the disease section of the HPA (<https://www.proteinatlas.org/humanproteome/disease>).

Scripts used to create the figures here can be found here: <https://github.com/eemiljohansson/AML-profiling>.

# Set up

## Packages

These packages are used in the analysis:

```{r Loading packages, warning=FALSE}
# Loading packages
library(tidyverse) # v.2.0.0
library(tidymodels) # v.1.1.1
library(embed) # v.1.1.3
library(umap) # v0.2.10.0
library(ggrepel) # v.0.9.4
library(readxl) # v.1.4.3
library(openxlsx) # v.4.2.7
library(HDAnalyzeR) # v.1.0.0
library(ggridges) # v.0.5.6
library(patchwork) # v.1.3.0
library(ComplexUpset) # v.1.3.3
library(MatchIt) # v.4.6.0
library(caret) # v.6.0-94
library(doParallel) # v.1.0.17
library(vip) # v.0.4.1
library(viridis) # v.0.6.5
library(fmsb) # v.0.7.6
library(RColorBrewer) # v.1.1-3
```

## Scripts

These Scripts were used in the analysis:
Make sure to replace the paths with the correct paths to the scripts. Example: "<your_path>/functions_disease_analyses.R>".

```{r Loading scripts}
source("scripts/functions_disease_analyses.R")
source("scripts/custom_plots.R")
```

## Data

The data used in this analysis is from the Human Protein Atlas (HPA) (<https://www.proteinatlas.org/>). The data is presented in the disease section of the HPA (<https://www.proteinatlas.org/humanproteome/disease>).

```{r Loading data, warning=FALSE}
# Read data
data_long <-  read_csv("data/olink_data.csv")
metadata <- read.xlsx("data/metadata.xlsx")
rownames(metadata) <- NULL
```

```{r}
data_wide <- data_long |>
  pivot_wider(names_from = Assay, values_from = NPX)
```


# Feature selection by LASSO

## Feature selection

### Healthy controls

```{r}
case <- "AML"
control <- "Healthy"

lasso_res_aml_healthy <- do_rreg(olink_data = data_wide |>
                                   filter(DAid %in% (metadata |>
                                                       filter(Disease %in% c(case, control)))$DAid), 
                          metadata = metadata |> 
                            filter(Disease %in% c(case, control)), 
                          case = case,
                          control = control,
                          strata = FALSE,
                          only_female = c("Breast", "Ovarian", "Cervical", "Endometrial"),
                          only_male = c("Pancreatic"),
                          exclude_cols = c("Sex", "Age"),
                          ratio = 0.7,
                          type = "lasso",
                          cor_threshold = 0.9,
                          cv_sets = 5,
                          grid_size = 10,
                          subtitle = c("accuracy", 
                                       "sensitivity", 
                                       "specificity", 
                                       "auc", 
                                       "features",
                                       "top-features"),
                          points = FALSE,
                          varimp_yaxis_names = TRUE,
                          boxplot_xaxis_names = FALSE,
                          seed = 123)
```

```{r}
features_aml_healthy <-  lasso_res_aml_healthy$var_imp_res$features |>
  # If the Sign is NEG, then Importance should be negative
  mutate(Importance = ifelse(Sign == "NEG", -Importance, Importance)) |>
  ggplot(aes(x = reorder(Variable, abs(Importance)), y = Importance, fill = Importance)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis(begin = 1, end = 0, option = "plasma") +
  labs(x = "Protein", y = "Model importance") +
  theme_light() +
  coord_flip() +
  guides(fill = F)

features_aml_healthy
```

### Pan-cancer controls

```{r}
case <- "AML"
control <- c("CLL", "DLBCL", "Myeloma", "Colorectal", "Lung", "Glioma", "Breast", "Cervical", "Endometrial", "Ovarian", "Prostate", "HCC", "Pancreatic")

lasso_res_aml_cancer <- do_rreg(olink_data = data_wide |>
                                   filter(DAid %in% (metadata |>
                                                       filter(Disease %in% c(case, control)))$DAid), 
                          metadata = metadata |> 
                            filter(Disease %in% c(case, control)), 
                          case = case,
                          control = control,
                          strata = FALSE,
                          only_female = c("Breast", "Ovarian", "Cervical", "Endometrial"),
                          only_male = c("Pancreatic"),
                          exclude_cols = c("Sex", "Age"),
                          ratio = 0.7,
                          type = "lasso",
                          cor_threshold = 0.9,
                          cv_sets = 5,
                          grid_size = 10,
                          subtitle = c("accuracy", 
                                       "sensitivity", 
                                       "specificity", 
                                       "auc", 
                                       "features",
                                       "top-features"),
                          points = FALSE,
                          varimp_yaxis_names = TRUE,
                          boxplot_xaxis_names = FALSE,
                          seed = 123)
```

```{r}
features_aml_cancer <-  lasso_res_aml_cancer$var_imp_res$features |>
  mutate(Importance = ifelse(Sign == "NEG", -Importance, Importance)) |>
  ggplot(aes(x = reorder(Variable, abs(Importance)), y = Importance, fill = Importance)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis(begin = 1, end = 0, option = "plasma") +
  labs(x = "Protein", y = "Model importance") +
  theme_light() +
  coord_flip() +
  guides(fill = F)

features_aml_cancer
```

### Hematological malignancies

```{r}
case <- "AML"
control <- c("CLL", "DLBCL", "Myeloma")

lasso_res_aml_hm <- do_rreg(olink_data = data_wide |>
                                   filter(DAid %in% (metadata |>
                                                       filter(Disease %in% c(case, control)))$DAid), 
                          metadata = metadata |> 
                            filter(Disease %in% c(case, control)), 
                          case = case,
                          control = control,
                          only_female = c("Breast", "Ovarian", "Cervical", "Endometrial"),
                          only_male = c("Pancreatic"),
                          exclude_cols = c("Sex", "Age"),
                          ratio = 0.7,
                          type = "lasso",
                          cor_threshold = 0.9,
                          cv_sets = 5,
                          grid_size = 10,
                          subtitle = c("accuracy", 
                                       "sensitivity", 
                                       "specificity", 
                                       "auc", 
                                       "features",
                                       "top-features"),
                          points = FALSE,
                          varimp_yaxis_names = TRUE,
                          boxplot_xaxis_names = FALSE,
                          seed = 123)
```

```{r}
features_aml_hm <-  lasso_res_aml_hm$var_imp_res$features |>
  mutate(Importance = ifelse(Sign == "NEG", -Importance, Importance)) |>
  ggplot(aes(x = reorder(Variable, abs(Importance)), y = Importance, fill = Importance)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis(begin = 1, end = 0, option = "plasma") +
  labs(x = "Protein", y = "Model importance") +
  theme_light() +
  coord_flip() +
  guides(fill = F)

features_aml_hm
```

### CLL

```{r}
case <- "AML"
control <- c("CLL")

metadata |> distinct(Disease)

lasso_res_aml_cll <- do_rreg(olink_data = data_wide |>
                                   filter(DAid %in% (metadata |>
                                                       filter(Disease %in% c(case, control)))$DAid), 
                          metadata = metadata |> 
                            filter(Disease %in% c(case, control)), 
                          case = case,
                          control = control,
                          only_female = c("Breast", "Ovarian", "Cervical", "Endometrial"),
                          only_male = c("Pancreatic"),
                          exclude_cols = c("Sex", "Age"),
                          ratio = 0.7,
                          type = "lasso",
                          cor_threshold = 0.9,
                          cv_sets = 5,
                          grid_size = 10,
                          subtitle = c("accuracy", 
                                       "sensitivity", 
                                       "specificity", 
                                       "auc", 
                                       "features",
                                       "top-features"),
                          points = FALSE,
                          varimp_yaxis_names = TRUE,
                          boxplot_xaxis_names = FALSE,
                          seed = 123)
```

```{r}
features_aml_cll <-  lasso_res_aml_cll$var_imp_res$features |>
  mutate(Importance = ifelse(Sign == "NEG", -Importance, Importance)) |>
  ggplot(aes(x = reorder(Variable, abs(Importance)), y = Importance, fill = Importance)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis(begin = 1, end = 0, option = "plasma") +
  labs(x = "Protein", y = "Model importance") +
  theme_light() +
  coord_flip() +
  guides(fill = F)

features_aml_cll
```

### DLBCL

```{r}
case <- "AML"
control <- "DLBCL"

lasso_res_aml_dlbcl <- do_rreg(olink_data = data_wide |>
                                   filter(DAid %in% (metadata |>
                                                       filter(Disease %in% c(case, control)))$DAid), 
                          metadata = metadata |> 
                            filter(Disease %in% c(case, control)), 
                          case = case,
                          control = control,
                          only_female = c("Breast", "Ovarian", "Cervical", "Endometrial"),
                          only_male = c("Pancreatic"),
                          exclude_cols = c("Sex", "Age"),
                          ratio = 0.7,
                          type = "lasso",
                          cor_threshold = 0.9,
                          cv_sets = 5,
                          grid_size = 10,
                          subtitle = c("accuracy", 
                                       "sensitivity", 
                                       "specificity", 
                                       "auc", 
                                       "features",
                                       "top-features"),
                          points = FALSE,
                          varimp_yaxis_names = TRUE,
                          boxplot_xaxis_names = FALSE,
                          seed = 123)
```

```{r}
features_aml_dlbcl <-  lasso_res_aml_dlbcl$var_imp_res$features |>
  mutate(Importance = ifelse(Sign == "NEG", -Importance, Importance)) |>
  ggplot(aes(x = reorder(Variable, abs(Importance)), y = Importance, fill = Importance)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis(begin = 1, end = 0, option = "plasma") +
  labs(x = "Protein", y = "Model importance") +
  theme_light() +
  coord_flip() +
  guides(fill = F)

features_aml_dlbcl
```

### Myeloma

```{r}
case <- "AML"
control <- "Myeloma"

lasso_res_aml_myeloma <- do_rreg(olink_data = data_wide |>
                                   filter(DAid %in% (metadata |>
                                                       filter(Disease %in% c(case, control)))$DAid), 
                          metadata = metadata |> 
                            filter(Disease %in% c(case, control)), 
                          case = case,
                          control = control,
                          only_female = c("Breast", "Ovarian", "Cervical", "Endometrial"),
                          only_male = c("Pancreatic"),
                          exclude_cols = c("Sex", "Age"),
                          ratio = 0.7,
                          type = "lasso",
                          cor_threshold = 0.9,
                          cv_sets = 5,
                          grid_size = 10,
                          subtitle = c("accuracy", 
                                       "sensitivity", 
                                       "specificity", 
                                       "auc", 
                                       "features",
                                       "top-features"),
                          points = FALSE,
                          varimp_yaxis_names = TRUE,
                          boxplot_xaxis_names = FALSE,
                          seed = 123)
```

```{r}
features_aml_myeloma <-  lasso_res_aml_myeloma$var_imp_res$features |>
  mutate(Importance = ifelse(Sign == "NEG", -Importance, Importance)) |>
  ggplot(aes(x = reorder(Variable, abs(Importance)), y = Importance, fill = Importance)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis(begin = 1, end = 0, option = "plasma") +
  labs(x = "Protein", y = "Model importance") +
  theme_light() +
  coord_flip() +
  guides(fill = F)

features_aml_myeloma
```

## ROC curves

```{r}
# Assuming 'roc_plot' is the ROC curve plot from the 'lasso_res_aml_healthy$testfit_res$metrics' data
roc_plot_aml_healthy <- lasso_res_aml_healthy$testfit_res$metrics$roc_curve

# Calculate metrics
auc_aml_healthy <- round(lasso_res_aml_healthy$testfit_res$metrics$auc, 2)
accuracy_aml_healthy <- round(lasso_res_aml_healthy$testfit_res$metrics$accuracy, 2)
sensitivity_aml_healthy <- round(lasso_res_aml_healthy$testfit_res$metrics$sensitivity, 2)
specificity_aml_healthy <- round(lasso_res_aml_healthy$testfit_res$metrics$specificity, 2)

# Prepare annotation text
metrics_text <- sprintf(
  "AUC = %s\nAccuracy = %s\nSensitivity = %s\nSpecificity = %s",
  auc_aml_healthy, accuracy_aml_healthy, sensitivity_aml_healthy, specificity_aml_healthy
)

# Add annotations to the ROC curve plot
roc_plot_aml_healthy + 
  annotate("text", x = 0.8, y = 0.2, label = metrics_text, size = 5, hjust = 1, vjust = 1) +
  theme_light()
```

```{r}
# Define a list of diseases
diseases <- c("healthy", "cancer", "hm", "cll", "dlbcl", "myeloma")
roc_data <- list(
  healthy = lasso_res_aml_healthy,
  cancer = lasso_res_aml_cancer,
  hm = lasso_res_aml_hm,
  cll = lasso_res_aml_cll,
  dlbcl = lasso_res_aml_dlbcl,
  myeloma = lasso_res_aml_myeloma
)

# Function to generate ROC plot and extract metrics for a given disease
generate_roc_plot_and_metrics <- function(roc_result, disease_name) {
  # Assuming each result object has the same structure as lasso_res_aml_healthy
  roc_plot <- roc_result$testfit_res$metrics$roc_curve
  auc <- round(roc_result$testfit_res$metrics$auc, 2)
  accuracy <- round(roc_result$testfit_res$metrics$accuracy, 2)
  sensitivity <- round(roc_result$testfit_res$metrics$sensitivity, 2)
  specificity <- round(roc_result$testfit_res$metrics$specificity, 2)

  # Prepare annotation text
  metrics_text <- sprintf(
    "AUC = %s\nAccuracy = %s\nSensitivity = %s\nSpecificity = %s",
    auc, accuracy, sensitivity, specificity
  )

  # Create ROC plot
  plot <- roc_plot + 
    annotate("text", x = 0.8, y = 0.2, label = metrics_text, size = 5, hjust = 1, vjust = 1) +
    labs(title = sprintf("ROC Curve for AML vs. %s", toupper(disease_name))) +
    theme_light()

  # Return both plot and metrics in a list
  list(
    Plot = plot,
    Metrics = data.frame(
      Disease = disease_name,
      AUC = auc,
      Accuracy = accuracy,
      Sensitivity = sensitivity,
      Specificity = specificity
    )
  )
}

# Apply the function to each disease and collect results
results <- lapply(names(roc_data), function(disease) generate_roc_plot_and_metrics(roc_data[[disease]], disease))

# Extract plots and metrics separately
roc_plots <- lapply(results, `[[`, "Plot")
metrics_summary <- do.call(rbind, lapply(results, `[[`, "Metrics"))

# Now roc_plots contains all the ROC curve plots, and metrics_summary contains a data frame of all metrics
print(roc_plots)  # This will print all plots
print(metrics_summary)  # This will show the summary table of metrics
```

## Confusion matrices

```{r}
conf_matrix_df <- as.data.frame.matrix(lasso_res_aml_healthy$testfit_res$metrics$conf_matrix$table)
conf_aml_healthy <- create_conf_plot(lasso_res_aml_healthy$testfit_res$metrics$conf_matrix$table, "Healthy", "AML")
conf_aml_healthy
```

```{r}
conf_matrix_df <- as.data.frame.matrix(lasso_res_aml_cancer$testfit_res$metrics$conf_matrix$table)
conf_aml_cancer <- create_conf_plot(conf_matrix_df, "Pan-cancer", "AML")
conf_aml_cancer
```

```{r}
conf_matrix_df <- as.data.frame.matrix(lasso_res_aml_hm$testfit_res$metrics$conf_matrix$table)
conf_aml_hm <- create_conf_plot(conf_matrix_df, "Hematological malignancies", "AML")
conf_aml_hm
```

```{r}
conf_matrix_df <- as.data.frame.matrix(lasso_res_aml_cll$testfit_res$metrics$conf_matrix$table)
conf_aml_cll <- create_conf_plot(conf_matrix_df, "CLL", "AML")
conf_aml_cll
```

```{r}
conf_matrix_df <- as.data.frame.matrix(lasso_res_aml_dlbcl$testfit_res$metrics$conf_matrix$table)
conf_aml_dlbcl <- create_conf_plot(conf_matrix_df, "DLBCL", "AML")
conf_aml_dlbcl
```

```{r}
conf_matrix_df <- as.data.frame.matrix(lasso_res_aml_myeloma$testfit_res$metrics$conf_matrix$table)
conf_aml_myeloma <- create_conf_plot(conf_matrix_df, "Myeloma", "AML")
conf_aml_myeloma
```

## Example boxplots

```{r ML example boxplots, fig.width=20, fig.height=5}
ml_example_boxplots <- olink_data_long %>%
  select(DAid, Assay, NPX) %>%
  left_join(metadata, by = "DAid") %>%
  filter(Assay %in% c("LCN2", "CDH17", "FCGR3B", "TNFRSF10C")) %>%
  mutate(Assay = factor(Assay, levels = c("LCN2", "CDH17", "FCGR3B", "TNFRSF10C"))) %>%
  ggplot(aes(x = factor(Disease, levels = names(pal_aml_healthy)), y = NPX, color = Disease, fill = Disease)) + 
  geom_quasirandom(alpha = 0.8, show.legend = FALSE) + 
  geom_boxplot(color = "black", outlier.color = NA, alpha = 0.7) + 
  facet_wrap(~ Assay, nrow = 1, scales = "free_y") + 
  scale_color_manual(values = pal_aml_healthy) + 
  scale_fill_manual(values = pal_aml_healthy) +
  theme_light() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Cancer") +
  guides(fill = FALSE, color = FALSE)

ml_example_boxplots
```