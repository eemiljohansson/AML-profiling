---
title: "Blood plasma profiling using proximity extension assay in patients with acute myeloid leukemia"
subtitle: "Exploratory analyses"
author: "Emil Johansson, María Bueno Álvez, Sören Lehmann, Tobias Sjöblom, Ulf Gyllensten, Fredrik Pontén, Göran Bergström, Adil Mardinouglu, Wen Zhong, Mathias Uhlén & Fredrik Edfors"
date: last-modified
date-format: "dddd [the] Do [of] MMMM YYYY"
format:
  html:
    theme: lumen
    title-block-banner: true
    smooth-scroll: true
    toc: true
    toc-depth: 4
    toc-location: right
    number-sections: true
    number-depth: 4
    code-fold: true
    code-tools: true
    code-copy: true
    code-overflow: wrap
    df-print: kable
    standalone: true
    fig-align: left
    figure:
      caption: "Figure {number}: {label}"
editor_options: 
  chunk_output_type: inline
execute:
  echo: true
  message: false
  warning: false
params: 
  disease: "Abdominal aortic aneruysm"
editor: 
  markdown: 
    wrap: 72
---

Start of document.

# Background

## Introduction

Welcome to the quarto report presenting the code used to generate the content to the article: "Blood proteome profiling using proximity extension assay in patients with acute myeloid leukemia" by Emil Johansson, María Bueno Álvez, Sören Lehmann, Tobias Sjöblom, Ulf Gyllensten, Fredrik Pontén, Göran Bergström, Adil Mardinouglu, Wen Zhong, Mathias Uhlén & Fredrik Edfors..

## The study

The results from the study are published in **insert journal**: Johansson, E, et al. Blood proteome profiling using proximity extension assay in patients with acute myeloid leukemia. Insert journal here\* (2024). **insert DOI here**

## Access the data/scripts

The results generated by this study can be accessed through the Human Protein Atlas (HPA) (<https://www.proteinatlas.org/>). More specifically, the data is presented in the disease section of the HPA (<https://www.proteinatlas.org/humanproteome/disease>).

Scripts used to create the figures here can be found here: <https://github.com/eemiljohansson/AML-profiling>.

# Set up

## Packages

These packages are used in the analysis:

```{r Loading packages, warning=FALSE}
# Loading packages
library(tidyverse) # v.2.0.0
library(embed) # v.1.1.3
library(umap) # v0.2.10.0
library(ggrepel) # v.0.9.4
library(readxl) # v.1.4.3
library(openxlsx) # v.4.2.7
library(HDAnalyzeR) # v.1.0.0
library(ggridges) # v.0.5.6
library(patchwork) # v.1.3.0
library(ComplexUpset) # v.1.3.3
library(doParallel) # v.1.0.17
library(viridis) # v.0.6.5
library(fmsb) # v.0.7.6
library(RColorBrewer) # v.1.1-3
```

## Scripts

These Scripts were used in the analysis:
Make sure to replace the paths with the correct paths to the scripts. Example: "<your_path>/functions_disease_analyses.R>".

```{r Loading scripts}
source("../scripts/functions/functions_disease_analyses.R")
source("../scripts/functions/custom_plots.R")
```

## Data

The data used in this analysis is from the Human Protein Atlas (HPA) (<https://www.proteinatlas.org/>). The data is presented in the disease section of the HPA (<https://www.proteinatlas.org/humanproteome/disease>).

```{r Loading data, warning=FALSE}
# Read data
data_long <-  read_csv("../data/data_long.csv")
data_wide <-  read_csv("../data/data_wide.csv")
metadata <- read.csv("../data/metadata.csv")
```

```{r Setting levels, include=FALSE}
# Setting levels
levels_pan_cancer <- c("AML", "CLL", "DLBCL", "Myeloma", "Colorectal", "Lung", "Glioma", "Breast", "Cervical", "Endometrial", "Ovarian", "Prostate", "HCC", "Pancreatic")
levels_all <- c(levels_pan_cancer, "Healthy")
```

```{r Setting palettes, include=FALSE}
# Defining sex-specific colors
pal_sex <- c("#30D5C8", "lightpink")
pal_sex <- setNames(pal_sex, c("M", "F"))
  
# Defining disease-specific colors
pal_all <- c("#8D9FCA", "#E8A29A", "#CDB18A", 
                 "#2271B5", "#B89B74", "#9E0142", 
                 "#B195AE", "#FFD321", "#D1CBE5", 
                 "#ADC74F", "#6D6D6D", "#66C2A5", 
                 "#603479", "#96C08E", "#E7662B")
pal_all <- setNames(pal_all, c("AML", "Breast", "Healthy", 
                                      "CLL", "Colorectal", "Cervical", 
                                      "Endometrial", "Glioma", "HCC", 
                                      "Lung", "DLBCL", "Myeloma", 
                                      "Ovarian", "Pancreatic", "Prostate"))


# Defining hematological cancer-specific colors
pal_hm <- c("#8D9FCA", "grey", "grey",
                   "#2271B5", "grey", "grey",
                   "grey", "grey", "grey",
                   "grey", "#6D6D6D", "#66C2A5", 
                   "grey", "grey", "grey")
pal_hm <- setNames(pal_hm, c("AML", "Breast", "Healthy", 
                                           "CLL", "Colorectal", "Cervical", 
                                           "Endometrial", "Glioma", "HCC", 
                                           "Lung", "DLBCL", "Myeloma", 
                                           "Ovarian", "Pancreatic", "Prostate"))

# Defining AML-healthy specific colors
pal_aml_healthy <- c("#CDB18A","#8D9FCA", "grey", 
                   "grey", "grey", "grey",
                   "grey", "grey", "grey",
                   "grey", "grey", "grey", 
                   "grey", "grey", "grey")
pal_aml_healthy <- setNames(pal_aml_healthy, c("Healthy", "AML", "CLL", 
                                           "DLBCL", "Myeloma", "Breast", 
                                           "Cervical", "Colorectal",
                                           "Endometrial", "Glioma", "HCC", "Lung", 
                                           "Ovarian", "Pancreatic", "Prostate"))
  
# Define colors for differential expression
pal_de <- c("#D3D3D3", "#FF7176", "#92C9DA")
pal_de <- setNames(pal_de, c("not significant", "significant up", "significant down"))
```

# Cohort overview

## Age

Describing the age distribution of the different cohorts as box plots.

```{r Age distrbution, fig.width=10, fig.height=7}
# Age distribution (box plot)
age_plot <- metadata |>
  filter(Age != 0) |>
  ggplot(aes(x = Age, y = factor(Disease, levels = rev(levels_all)), fill = Disease)) +
  geom_boxplot(color = "black") +
  labs(x = "Age", y = "Cohort") +
  scale_fill_manual(values = pal_all) +
  theme_light() +
  guides(fill = FALSE)

age_plot
```

## Sex

Describing the sex distribution as bar plots. 

```{r Sex distrbution, fig.width=10, figheight=7}
# Sex distribution (bar plot)
sex_plot <- metadata |>
  filter(!is.na(Sex)) |>
  group_by(Disease, Sex) |>
  summarise(Count = n()) |> 
  ggplot(aes(x = factor(Disease, levels = rev(levels_all)), y = Count, fill = Sex)) +
  geom_col(position = "stack", color = "black", width = 0.7) +
  labs(x = "Cancer", y = "Number of samples") +
  theme_light() +
  scale_fill_manual(values = pal_sex) +
  coord_flip() +
  theme(legend.position = "top")

sex_plot
```

```{r Age and sex, fig.width=20, fig.height=7}
sex_plot + age_plot
```

```{r Cohort description, include=FALSE}
# Define the age interval length
interval_length <- 10

# Create a new variable for age intervals
cohort_description <- metadata |>
  filter(!is.na(Age)) |>
  mutate(AgeInterval = cut(Age, breaks = seq(0, max(Age) + interval_length, by = interval_length))) |>
  select(-Age) |>
  arrange(Disease, AgeInterval) |>
  # Replace DAid with a unique identifier of AML and patient number. Example: AML_patient1, AML_patient2, etc. and for every disease, but starting from 1 again for every new disease
  group_by(Disease) |>
  mutate(Patient = row_number()) |>
  ungroup() |>
  mutate(DAid = paste(Disease, "patient", Patient, sep = "_")) |>
  select(-Patient)
```

## UMAP

```{r UMAP}
# Default seed is 123
umap_data <- hd_umap(dat = data_wide)
```

```{r UMAP means}
# Setting a seed
umap_data_means <- umap_data$umap_res |>
  left_join(metadata, by = "DAid") |>
  group_by(Disease) |>
  summarize(UMAP1_mean = mean(UMAP1), UMAP2_mean = mean(UMAP2))
```

```{r UMAP plot all colors, fig.width=10, fig.height=7}
umap_all <- umap_data$umap_res |>
  right_join(metadata, by = "DAid") |>
  ggplot(aes(UMAP1, UMAP2, color = Disease, fill = Disease)) +
  geom_point(aes(color = Disease), alpha = 0.7, size = 2) +
  geom_label_repel(data = umap_data_means, aes(x = UMAP1_mean, y = UMAP2_mean, label = Disease), 
                   box.padding = 0.5, point.padding = 0.2, segment.color = NA,
                   size = 4, color = "black", alpha = 0.7, fontface = "bold") +
  theme_light() +
  scale_color_manual(values = pal_all) +
  scale_fill_manual(values = pal_all)
  #+ guides(fill = F, color = F)

umap_all

ggsave("../plots/UMAP/UMAP all.pdf", width = 10, height = 7)
```

### Highlighting hematological malignancies

```{r UMAP plot HM colors, fig.width=10, fig.height=7}
umap_hm <- umap_data$umap_res |>
  right_join(metadata, by = "DAid") |>
  ggplot(aes(UMAP1, UMAP2, color = Disease, fill = Disease)) +
  geom_point(aes(color = Disease), alpha = 0.7, size = 2) +
  geom_label_repel(data = umap_data_means, aes(x = UMAP1_mean, y = UMAP2_mean, label = Disease), 
                   box.padding = 0.5, point.padding = 0.2, segment.color = NA,
                   size = 4, color = "black", alpha = 0.8, fontface = "bold") +
  theme_light() +
  scale_color_manual(values = pal_hm) +
  scale_fill_manual(values = pal_hm)
  #+ guides(fill = F, color = F)

umap_hm

ggsave("../plots/UMAP/UMAP hematological malignancies.pdf", width = 10, height = 7)
```

```{r Supplementary UMAP, fig.width=10, fig.height=14}
umap_all / umap_hm 

ggsave("../plots/UMAP/UMAP all and HM.pdf", width = 10, height = 14)
```


