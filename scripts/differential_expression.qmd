---
title: "Blood plasma profiling using proximity extension assay in patients with acute myeloid leukemia"
subtitle: "Differential expression analyses"
author: "Emil Johansson, María Bueno Álvez, Sören Lehmann, Tobias Sjöblom, Ulf Gyllensten, Fredrik Pontén, Göran Bergström, Adil Mardinouglu, Wen Zhong, Mathias Uhlén & Fredrik Edfors"
date: last-modified
date-format: "dddd [the] Do [of] MMMM YYYY"
format:
  html:
    theme: lumen
    title-block-banner: true
    smooth-scroll: true
    toc: true
    toc-depth: 4
    toc-location: right
    number-sections: true
    number-depth: 4
    code-fold: true
    code-tools: true
    code-copy: true
    code-overflow: wrap
    df-print: kable
    standalone: true
    fig-align: left
    figure:
      caption: "Figure {number}: {label}"
editor_options: 
  chunk_output_type: inline
execute:
  echo: true
  message: false
  warning: false
params: 
  disease: "Abdominal aortic aneruysm"
editor: 
  markdown: 
    wrap: 72
---

# Load packages

```{r Loading packages, warning=FALSE}
library(tidyverse) # v.2.0.0
library(embed) # v.1.1.3
library(umap) # v0.2.10.0
library(ggrepel) # v.0.9.4
library(readxl) # v.1.4.3
library(openxlsx) # v.4.2.7
library(HDAnalyzeR) # v.1.0.0
library(ggridges) # v.0.5.6
library(patchwork) # v.1.3.0
library(ComplexUpset) # v.1.3.3
library(doParallel) # v.1.0.17
library(viridis) # v.0.6.5
library(fmsb) # v.0.7.6
library(RColorBrewer) # v.1.1-3
```

# Source scrips

```{r Loading scripts}
source("../scripts/functions/functions_disease_analyses.R")
source("../scripts/functions/custom_plots.R")
```

# Read data

```{r Loading data, warning=FALSE}
# Read data
data_long <-  read_csv("../data/data_long.csv")
data_wide <- read_csv("../data/data_wide.csv")
metadata <- read_csv("../data/metadata.csv")
```

```{r Setting levels, include=FALSE}
# Setting levels
levels_pan_cancer <- c("AML", "CLL", "DLBCL", "Myeloma", "Colorectal", "Lung", "Glioma", "Breast", "Cervical", "Endometrial", "Ovarian", "Prostate", "HCC", "Pancreatic")
levels_all <- c(levels_pan_cancer, "Healthy")
```

```{r Setting palettes, include=FALSE}
# Defining sex-specific colors
pal_sex <- c("#30D5C8", "lightpink")
pal_sex <- setNames(pal_sex, c("Male", "Female"))
  
# Defining disease-specific colors
pal_all <- c("#8D9FCA", "#E8A29A", "#CDB18A", 
                 "#2271B5", "#B89B74", "#9E0142", 
                 "#B195AE", "#FFD321", "#D1CBE5", 
                 "#ADC74F", "#6D6D6D", "#66C2A5", 
                 "#603479", "#96C08E", "#E7662B")
pal_all <- setNames(pal_all, c("AML", "Breast", "Healthy", 
                                      "CLL", "Colorectal", "Cervical", 
                                      "Endometrial", "Glioma", "HCC", 
                                      "Lung", "DLBCL", "Myeloma", 
                                      "Ovarian", "Pancreatic", "Prostate"))


# Defining hematological cancer-specific colors
pal_hm <- c("#8D9FCA", "grey", "grey",
                   "#2271B5", "grey", "grey",
                   "grey", "grey", "grey",
                   "grey", "#6D6D6D", "#66C2A5", 
                   "grey", "grey", "grey")
pal_hm <- setNames(pal_hm, c("AML", "Breast", "Healthy", 
                                           "CLL", "Colorectal", "Cervical", 
                                           "Endometrial", "Glioma", "HCC", 
                                           "Lung", "DLBCL", "Myeloma", 
                                           "Ovarian", "Pancreatic", "Prostate"))

# Defining AML-healthy specific colors
pal_aml_healthy <- c("#CDB18A","#8D9FCA", "grey", 
                   "grey", "grey", "grey",
                   "grey", "grey", "grey",
                   "grey", "grey", "grey", 
                   "grey", "grey", "grey")
pal_aml_healthy <- setNames(pal_aml_healthy, c("Healthy", "AML", "CLL", 
                                           "DLBCL", "Myeloma", "Breast", 
                                           "Cervical", "Colorectal",
                                           "Endometrial", "Glioma", "HCC", "Lung", 
                                           "Ovarian", "Pancreatic", "Prostate"))
  
# Define colors for differential expression
pal_de <- c("#D3D3D3", "#FF7176", "#92C9DA")
pal_de <- setNames(pal_de, c("not significant", "significant up", "significant down"))
```

Overview of the Olink data and metadata:

```{r Head olink_data_long}
head(data_long)
```

```{r Head metadata}
head(metadata)
```

# Figure 2: Differential expression analysis

## Comparing AML patients to different controls

### A: Healthy

```{r}
# Run differential expression using limma
de_aml_healthy <- hd_de_limma(
  dat = data_wide,
  metadata = metadata,
  case = "AML",
  control = "Healthy",
  correct = c("Sex", "Age")
  )
```

Differential expressed proteins in AML - Healthy controls.

```{r}
# Upregulated proteins
de_aml_healthy_sig_up <- de_aml_healthy$de_res %>%
  filter(sig == "significant up") %>%
  nrow()

cat("Number of significant upregulated proteins in AML - Healthy:", de_aml_healthy_sig_up)

# Downregulated proteins
de_aml_healthy_sig_down <- de_aml_healthy$de_results %>%
  filter(sig == "significant down") %>%
  nrow()

cat("\nNumber of significant downregulated proteins in AML - Healthy:", de_aml_healthy_sig_down)
```

```{r DE AML vs healthy volcano, fig.width=10, fig.height=10}
# Plot volcano plot for the results
volcano_aml_healthy <- plot_volcano(de_aml_healthy$de_results)
volcano_aml_healthy
```

### B: Pan-cancer

```{r DE AML vs pan-cancer limma}
# Run differential expression using limma
de_aml_cancer <- do_limma(olink_data = data_long,
         metadata = metadata,
         case = "AML",
         control = c("Lung", "Ovarian", "Glioma", "Cervical", "Colorectal", "Prostate", "Breast", "Myeloma", "DLBCL", "CLL", "Endometrial", "HCC", "Pancreatic"),
         correct = c("Sex", "Age"),
         wide = FALSE,
         only_female = c("Ovarian, Breast", "Cervical", "Endometrial"),
         only_male = c("Prostate"))
```

Differential expressed proteins in AML - Pan-cancer controls.

```{r}
# Upregulated proteins
de_aml_cancer_sig_up <- de_aml_cancer$de_results %>%
  filter(sig == "significant up") %>%
  nrow()

cat("Number of significant upregulated proteins in AML - Pan-cancer:", de_aml_cancer_sig_up)

# Downregulated proteins
de_aml_cancer_sig_down <- de_aml_cancer$de_results %>%
  filter(sig == "significant down") %>%
  nrow()
```

```{r DE AML vs pan-cancer volcano plot, fig.width=10, fig.height=10}
# Plot volcano plot for the results
volcano_aml_cancer <-  plot_volcano(de_aml_cancer$de_results)
volcano_aml_cancer
```

```{r DE AML vs healthy and pan-cancer, fig.width=20, fig.height=10}
volcano_aml_healthy + volcano_aml_cancer
```

## C: Comparing Healthy and Pan-cancer controls

Comparing the log2-fold change between the healthy and pan-cancer controls.

```{r Comparing DE healthy & pan-cancer controls, fig.width=10, fig.height=7}
# Comparing the Log2 fold changes between the healthy and pan-cancer controls
de_combined_healthy_cancer <- de_aml_healthy$de_results |> 
  select(Assay, logFC_healthy = logFC, adjpval_healthy = adj.P.Val) |> 
  left_join(de_aml_cancer$de_results |> 
              select(Assay, logFC_cancers = logFC, adjpval_cancers = adj.P.Val), by = "Assay")

# Annotate the top proteins
labels_scatter_healthy_cancer <- de_combined_healthy_cancer |> 
  top_n(n = 8, wt = abs(logFC_healthy + logFC_cancers)/2) 

de_aml_cancer_scatter <- de_combined_healthy_cancer |> 
  ggplot(aes(x = logFC_healthy, y = logFC_cancers, label = Assay, color = (logFC_healthy + logFC_cancers)/2)) +
  geom_point(size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE, color = "red", size = 1) +  # Add regression line
  geom_text_repel(data = labels_scatter_healthy_cancer, size = 4, 
                  box.padding = 0.8, 
                  segment.size = 0.5,
                  min.segment.length = 0,
                  max.overlaps = Inf,
                  arrow = arrow(length = unit(0.010, "npc")),
                  nudge_x = .15,
                  nudge_y = .5,
                  color = "grey50") +
  scale_color_gradient2(low = "blue", mid = "lightgray", high = "red", midpoint = 0) +
  annotate("text", x = max(de_combined_healthy_cancer$logFC_healthy), y = min(de_combined_healthy_cancer$logFC_cancers),
           label = sprintf("R = %.3f", cor(de_combined_healthy_cancer$logFC_healthy, de_combined_healthy_cancer$logFC_cancers)),
           hjust = 1, vjust = 0) +  # Add R value label
  scale_x_continuous(breaks = seq(floor(min(de_combined_healthy_cancer$logFC_healthy)), ceiling(max(de_combined_healthy_cancer$logFC_healthy)), by = 2.5)) +
  scale_y_continuous(breaks = seq(floor(min(de_combined_healthy_cancer$logFC_cancers)), ceiling(max(de_combined_healthy_cancer$logFC_cancers)), by = 2.5)) +
  theme_light()

de_aml_cancer_scatter
```

## D: Showing 4 boxplot examples across the controls

```{r DE example boxplots, fig.width=7, fig.height=10}
de_example_boxplots <- olink_data_long %>%
  select(DAid, Assay, NPX) %>%
  left_join(metadata, by = "DAid") %>%
  filter(Assay %in% c("FLT3", "FLT3LG", "EPO", "PGLYRP1")) %>%
  mutate(Assay = factor(Assay, levels = c("FLT3", "FLT3LG", "EPO", "PGLYRP1"))) %>%
  ggplot(aes(x = factor(Disease, levels = names(pal_aml_healthy)), y = NPX, color = Disease, fill = Disease)) + 
  geom_quasirandom(alpha = 0.8, show.legend = FALSE) + 
  geom_boxplot(color = "black", outlier.color = NA, alpha = 0.7) + 
  facet_wrap(~ Assay, ncol = 1, scales = "free_y") + 
  scale_color_manual(values = pal_aml_healthy) + 
  scale_fill_manual(values = pal_aml_healthy) +
  theme_light() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Cancer") +
  guides(fill = FALSE, color = FALSE)

de_example_boxplots
```

## Other controls

### S2C: Hematological malignancies

```{r DE AML vs hm limma}
# Run differential expression using limma
de_aml_hm <- do_limma(olink_data = data_long,
         metadata = metadata,
         case = "AML",
         control = c("CLL", "DLBCL", "Myeloma"),
         correct = c("Sex", "Age"),
         wide = FALSE)
```

Differential expressed proteins in AML - Hematological malignancies (CLL, DLBCL, Myeloma) as controls.

```{r}
# Upregulated proteins
de_aml_hm_sig_up <- de_aml_hm$de_results %>%
  filter(sig == "significant up") %>%
  nrow()

cat("Number of significant upregulated proteins in AML - Hematological malignancies:", de_aml_hm_sig_up)

# Downregulated proteins
de_aml_hm_sig_down <- de_aml_hm$de_results %>%
  filter(sig == "significant down") %>%
  nrow()

cat("\nNumber of significant downregulated proteins in AML - Hematological malignancies:", de_aml_hm_sig_down)
```

```{r DE AML vs hm volcano, fig.width=10, fig.height=7}
# Plot volcano plot for the results
volcano_aml_hm <- plot_volcano(de_aml_hm$de_results)
volcano_aml_hm
```

### S2D: CLL

```{r DE AML vs CLL limma}
# Run differential expression using limma
de_aml_cll <- do_limma(olink_data = data_long,
         metadata = metadata,
         case = "AML",
         control = "CLL",
         correct = c("Sex", "Age"),
         wide = FALSE)
```

Differential expressed proteins in AML - CLL controls.

```{r}
# Upregulated proteins
de_aml_cll_sig_up <- de_aml_cll$de_results %>%
  filter(sig == "significant up") %>%
  nrow()

cat("Number of significant upregulated proteins in AML - CLL:", de_aml_cll_sig_up)

# Downregulated proteins
de_aml_cll_sig_down <- de_aml_cll$de_results %>%
  filter(sig == "significant down") %>%
  nrow()

cat("\nNumber of significant downregulated proteins in AML - CLL:", de_aml_cll_sig_down)
```

```{r DE AML vs CLL volcano, fig.width=10, fig.height=7}
# Plot volcano plot for the results
volcano_aml_cll <- plot_volcano(de_aml_cll$de_results)
volcano_aml_cll
```

### S2E: DLBCL

```{r DE AML vs DLBCL limma}
# Run differential expression using limma
de_aml_dlbcl <- do_limma(olink_data = data_long,
         metadata = metadata,
         case = "AML",
         control = "DLBCL",
         correct = c("Sex", "Age"),
         wide = FALSE)
```

Differential expressed proteins in AML - DLBCL controls.

```{r}
# Upregulated proteins
de_aml_dlbcl_sig_up <- de_aml_dlbcl$de_results %>%
  filter(sig == "significant up") %>%
  nrow()

cat("Number of significant upregulated proteins in AML - DLBCL:", de_aml_dlbcl_sig_up)

# Downregulated proteins
de_aml_cancer_dlbcl_down <- de_aml_dlbcl$de_results %>%
  filter(sig == "significant down") %>%
  nrow()

cat("\nNumber of significant downregulated proteins in AML - DLBCL:", de_aml_cancer_dlbcl_down)
```

```{r DE AML vs DLBCL volcano, fig.width=10, fig.height=7}
# Plot volcano plot for the results
volcano_aml_dlbcl <- plot_volcano(de_aml_dlbcl$de_results)
volcano_aml_dlbcl
```

### S2F: Myeloma

```{r DE AML vs Myeloma limma}
# Run differential expression using limma
de_aml_myeloma <- do_limma(olink_data = data_long,
         metadata = metadata,
         case = "AML",
         control = "Myeloma",
         correct = c("Sex", "Age"),
         wide = FALSE)
```

Differential expressed proteins in AML - Myeloma controls.

```{r}
# Upregulated proteins
de_aml_myeloma_sig_up <- de_aml_myeloma$de_results %>%
  filter(sig == "significant up") %>%
  nrow()

cat("Number of significant upregulated proteins in AML - Myeloma:", de_aml_myeloma_sig_up)

# Downregulated proteins
de_aml_myeloma_sig_down <- de_aml_myeloma$de_results %>%
  filter(sig == "significant down") %>%
  nrow()

cat("\nNumber of significant downregulated proteins in AML - Myeloma:", de_aml_myeloma_sig_down)
```

```{r DE AML vs Myeloma volcano, fig.width=10, fig.height=7}
# Plot volcano plot for the results
volcano_aml_myeloma <- plot_volcano(de_aml_myeloma$de_results)
volcano_aml_myeloma
```

```{r Supplementary figures, fig.width=14, fig.height=20}
# Preparing figure S2
(volcano_aml_healthy + volcano_aml_cancer) / (volcano_aml_hm + volcano_aml_cll) / (volcano_aml_dlbcl + volcano_aml_myeloma)
```

```{r}
# Healthy control
protein_summary_aml_healthy <- de_aml_healthy$de_results |> 
  select(Assay, logFC, adj.P.Val, sig) |>
  rename(logFC_healthy = logFC, adj.P.Val_healthy = adj.P.Val, sig_healthy = sig)

# Pan-cancer control
protein_summary_aml_cancer <- de_aml_cancer$de_results |> 
  select(Assay, logFC, adj.P.Val, sig) |>
  rename(logFC_cancer = logFC, adj.P.Val_cancer = adj.P.Val, sig_cancer = sig)

# Hematological malignancies control
protein_summary_aml_hm <- de_aml_hm$de_results |> 
  select(Assay, logFC, adj.P.Val, sig) |>
  rename(logFC_hm = logFC, adj.P.Val_hm = adj.P.Val, sig_hm = sig)

# CLL control
protein_summary_aml_cll <- de_aml_cll$de_results |> 
  select(Assay, logFC, adj.P.Val, sig) |>
  rename(logFC_cll = logFC, adj.P.Val_cll = adj.P.Val, sig_cll = sig)

# DLBCL control
protein_summary_aml_dlbcl <- de_aml_dlbcl$de_results |> 
  select(Assay, logFC, adj.P.Val, sig) |>
  rename(logFC_lymphoma = logFC, adj.P.Val_lymphoma = adj.P.Val, sig_lymphoma = sig)

# Myeloma control
protein_summary_aml_myeloma <- de_aml_myeloma$de_results |> 
  select(Assay, logFC, adj.P.Val, sig) |>
  rename(logFC_myeloma = logFC, adj.P.Val_myeloma = adj.P.Val, sig_myeloma = sig)

# Save the DE results to an Excel file
protein_summary <- protein_summary_aml_healthy |> 
  right_join(protein_summary_aml_cancer, by = "Assay") |>
  right_join(protein_summary_aml_hm, by = "Assay") |>
  right_join(protein_summary_aml_cll, by = "Assay") |>
  right_join(protein_summary_aml_dlbcl, by = "Assay") |>
  right_join(protein_summary_aml_myeloma, by = "Assay")
```


